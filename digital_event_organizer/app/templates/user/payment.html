{% extends "base.html" %}
{% block title %}Payment - {{ order_data.event_title }}{% endblock %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
function initiatePayment() {
    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ order_data.amount }}",
        "currency": "{{ order_data.currency }}",
        "name": "Event Organizer",
        "description": "{{ order_data.event_title }}",
        "order_id": "{{ order_data.order_id }}",
        "handler": function (response){
            // Payment successful
            document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
            document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
            document.getElementById('razorpay_signature').value = response.razorpay_signature;
            document.getElementById('payment_id').value = "{{ order_data.payment_id }}";
            document.getElementById('payment-form').submit();
        },
        "prefill": {
            "name": "{{ user_name }}",
            "email": "{{ user_email }}"
        },
        "theme": {
            "color": "#0d6efd"
        }
    };
    
    var rzp = new Razorpay(options);
    rzp.on('payment.failed', function (response){
        alert('Payment failed. Please try again.');
        window.location.href = "{{ url_for('user.my_registrations') }}";
    });
    
    rzp.open();
}
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="bi bi-credit-card"></i> Complete Payment</h4>
                </div>
                <div class="card-body text-center">
                    <h5>{{ order_data.event_title }}</h5>
                    <hr>
                    <h3 class="text-primary">â‚¹{{ order_data.amount / 100 }}</h3>
                    <p class="text-muted">Amount to pay</p>
                    <button onclick="initiatePayment()" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-credit-card"></i> Pay Now
                    </button>
                    <hr>
                    <small class="text-muted">This is a test payment. Use Razorpay test cards.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="payment-form" method="POST" action="{{ url_for('payment.verify') }}" style="display:none;">
    <input type="hidden" name="payment_id" id="payment_id">
    <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
    <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
    <input type="hidden" name="razorpay_signature" id="razorpay_signature">
</form>
{% endblock %}
